#!/bin/bash
#
#SBATCH -J modisco_run
#
#SBATCH --output=models/tampere_pc_atac/BPH_651_AR_ATAC-UniBindPWM-samp-peaks_1000lambda_0.004lr_128batch_1000width_25tconv/slurm_logs/%x_%j.txt
#SBATCH --error=models/tampere_pc_atac/BPH_651_AR_ATAC-UniBindPWM-samp-peaks_1000lambda_0.004lr_128batch_1000width_25tconv/slurm_errors/%x_%j.txt
#
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=10
#
# time format hours:minutes:seconds or days-hours
#SBATCH --time=5:59:59
#SBATCH --mem=60000
#SBATCH --partition=parallel

## MODEL_DIR is the name of the directory in which the contribution scores (.h5) live
MODEL_DIR=models/tampere_pc_atac/BPH_651_AR_ATAC-UniBindPWM-samp-peaks_1000lambda_0.004lr_128batch_1000width_25tconv

TASKS=AR
TASK_LIST=$(echo ${TASKS} | tr '-' ' ')

CONTRIB_FILE=${MODEL_DIR}/contrib.deeplift.h5
CONTRIB_NULL_FILE=${MODEL_DIR}/contrib.deeplift.null.h5

MODISCO_DIR=${MODEL_DIR}/modisco

source ../../miniconda3/bin/activate ../../miniconda3/envs/bpnet_training

for task in ${TASK_LIST}; do
    echo -e "\n>>>\n\tTASK: ${task}\n>>>\n"
    bpnet modisco-run ${CONTRIB_FILE} --null-contrib-file=${CONTRIB_NULL_FILE} --override='TfModiscoWorkflow.min_metacluster_size = 1000' --contrib-wildcard=${task}/profile/wn --only-task-regions --premade=modisco-50k ${MODISCO_DIR}/${task}/ --overwrite;
    #bpnet modisco-run ${CONTRIB_FILE} --null-contrib-file=${CONTRIB_NULL_FILE} --override='TfModiscoWorkflow.min_metacluster_size = 1000' --contrib-wildcard=${task}/profile/wn --premade=modisco-50k ${MODISCO_DIR}/${task}/ --overwrite;
done
